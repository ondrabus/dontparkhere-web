<!doctype html>
<html>
<head>
	<title>Don't park here</title>
	<script src="https://api.mapy.cz/loader.js"></script>
	<script>
		Loader.load();
		
		const S4 = function () {
			return (((1+Math.random())*0x10000)|0).toString(16).substring(1); 
		}
		
		const newGuid = function() {	 
			// then to call it, plus stitch in '4' in the third group
			guid = (S4() + S4() + "-" + S4() + "-4" + S4().substr(0,3) + "-" + S4() + "-" + S4() + S4() + S4()).toLowerCase();
			return guid;
		}
		
		window.apiBaseUrl = 'https://dph.azurewebsites.net';
		window.instanceId = newGuid();
	</script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
	<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
	<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

	<style>
		html, body, #app { width: 100%; height: 100%; margin: auto; }
		
		body
		{
			font-family: 'Lato', sans-serif;
		}
		
		.panel
		{
			width: 100%;
			height: 40%;
			position: fixed;
			top: 60%;
			left: 0;
			z-index: 100;
			background: #fff; /*url("./bg.jpg") 50% 100%;*/
			padding: 10px;
			display: flex;
			align-items: center;

		}
		.panel > div
		{
			width: 50%;
			height: 100%;
			padding: 10%;
		}
		h3
		{
			font-size: 200%;
			font-weight: 100;
			margin-bottom: 0;
		}
		.messagebox.inprogress { animation: blinker 2s linear infinite; }
		@keyframes blinker { 50% { opacity: 0.25; } }

		
		.mapContainer
		{
			width: 100%;
			float: right;
			height: 60%;
			position: relative;
			
		}
		.messagebox
		{
			width: 100%;
			height: 50px;
			margin: 10px 0;
		}
		.success
		{
			color: green;
		}
		.error
		{
			color: red;
		}
		
		#map {
			position: relative;
			width: 100%;
			height: 100%;
		}
		
		@media screen and (min-width: 64em){
			.panel {
				width: 25%;
				height: 100%;
				top: 0;
				left: 0;
			}
			.panel > div {
				width: 100%;
				height: 50%;
			}
		
			.mapContainer {
				width: 75%;
				height: 100%;
			}
		}
	</style>
</head>

<body>
	<div id="app">
		<div class="mapContainer">
			<div id="map"></div>
		</div>
		<div class="panel">
			<div>
				<h3>Don't park here</h3>
				<div class="messagebox inprogress" v-if="!connected">
					Connecting to SignalR server, please wait...
				</div>
				<div class="messagebox" v-if="!sendingData && !dataReceived && connected">
					Connected! Pick a spot on the map.
				</div>
				<div class="messagebox inprogress" v-if="sendingData">
					Checking your spot, please wait...
				</div>
				<div :class="success ? 'messagebox success' : 'messagebox error'" v-if="dataReceived">
					<i class="fa fa-check fa-2x" v-if="success"></i>
					<i class="fa fa-hand-paper-o fa-2x" v-if="!success"></i><br />
					<p v-html="result"></p>
				</div>
			</div>
		</div>
	</div>	
	
	<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.0.3/dist/browser/signalr.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min.js"></script>
	
	
	
	<script type="text/javascript">
		const requestConfig = {
					headers: {
						"instanceId": window.instanceId
					}
				};
	
		let data = {
			sendingData: false,
			dataReceived: false,
			success: false,
			result: null,
			connected: false,
			position: [],
			instanceId: window.instanceId,
			map: null,
			markerLayer: null
		};

		const app = new Vue({
		  el: '#app',
		  data: data,
		  methods: {
		  
			getPosition: function(){
			  if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(this.setPosition);
			  }
			},
			
			setPosition: function(position){
				data.position = [position.coords.latitude, position.coords.longitude];
				console.log(position);
			},
			
			receiveMessage: function(message){
				data.sendingData = false;
				data.dataReceived = true;

				data.success = message.outputCode == 200;
				data.result = message.outputMessage.split("\n").join("<br>");
			},
			
			connectionClosed: function(){
				data.connected = false;
			}
		  },
		  
		  watch: {
			connected: function(val) {
				if (val)
				{
					this.getPosition();
				}
			},
			position: function() {
				console.log('position changed');
				
				let center = SMap.Coords.fromWGS84(data.position[1], data.position[0]);
				
				data.markerLayer.removeAll();
				data.markerLayer.addMarker(new SMap.Marker(center), "Car", {});
				data.map.setCenterZoom(center, 15, true);
				
				// send request
				data.sendingData = true;
				data.dataReceived = false;

				axios.post(`${apiBaseUrl}/api/InputSignalR`, {
					instanceId: data.instanceId,
					lat: data.position[0],
					lon: data.position[1]
				}, requestConfig)
				.then(resp => resp.data);
			}
		  },
		  
		  created: function(){
			axios.post(`${apiBaseUrl}/api/InputSignalRNegotiate`, null, requestConfig)
				.then(resp => resp.data)
				.then(info => {
					// make compatible with old and new SignalRConnectionInfo
					info.accessToken = info.accessToken || info.accessKey;
					info.url = info.url || info.endpoint;

					const options = {
						accessTokenFactory: () => info.accessToken
					};
					
					const connection = new signalR.HubConnectionBuilder()
						.withUrl(info.url, options)
						.configureLogging(signalR.LogLevel.Information)
						.build();

					connection.on('newMessage', this.receiveMessage);
					connection.onclose(this.connectionClosed);

					connection.start()
						.then(() => {
							data.connected = true;
							})
						.catch(console.error);
				}).catch(alert);
		  }
		});
		
				
				
		// add map
		
		var center = SMap.Coords.fromWGS84(16.6081525, 49.1951214);
		data.map = new SMap(JAK.gel("map"), center, 13);
		data.map.addControl(new SMap.Control.Sync());
		data.map.addDefaultLayer(SMap.DEF_BASE).enable();
		
		var mouse = new SMap.Control.Mouse(SMap.MOUSE_PAN | SMap.MOUSE_WHEEL | SMap.MOUSE_ZOOM);
		data.map.addControl(mouse);
		
		data.markerLayer = new SMap.Layer.Marker();
		data.map.addLayer(data.markerLayer);
		data.markerLayer.enable();
		
		data.map.getSignals().addListener(window, "map-click", function(e, elm) {
				var coords = SMap.Coords.fromEvent(e.data.event, data.map);
				data.position = [coords.y, coords.x];
			});
	</script>
  
</body>
</html>